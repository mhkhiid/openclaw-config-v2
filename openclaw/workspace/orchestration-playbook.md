# Orchestration Playbook — 复杂流程工程化规则

> 创建时间：2026-02-14
> 最后更新：2026-02-14
> 决策人：Alex + 助手圆

---

## 1. 任务评估与流程选择

### 轻量任务 → 直接做
- 单步可完成、风险低
- 不需要走标准流程，不用小题大做
- 直接执行，交付结果

### 复杂任务 → 标准流程
**判断标准（多因素综合，非硬性阈值）：**
- 涉及多个不同领域/工具？
- 需要分阶段交付？
- 失败后难以回退？
- 需要多个subagent协作？

任何一项明显为是 → 走标准流程。

### 标准流程
```
Step 1: 分析 — 拆解任务，识别依赖关系
Step 2: 计划 — 生成checklist（发日志群）
Step 3: 确认 — 简单直接执行；高风险/外部操作先问Alex
Step 4: 执行 — 按checklist推进（有依赖串行，无依赖并行）
Step 5: 汇报 — 最终结果发主对话
```

---

## 2. Subagent调用规则

### 何时使用Subagent
- 任务可独立执行，不需要与Alex实时交互
- 有并行价值（多个相似/独立子任务）
- 需要不同模型做不同子任务
- **前提：评估API/token可行性，确认rate_limit余量足够再spawn**

### 何时不用Subagent
- 需要Alex实时确认/反馈
- 任务简单，自己做更快
- 任务间有强依赖，只能串行
- API余量不足以支持并发

### Subagent提示词模板
```
你是助手圆的[任务名称]子任务。

【背景】简洁说明context
【目标】明确要交付什么
【步骤】1. 2. 3. 具体步骤
【输出】写入哪个文件/发送给谁/格式要求
【约束】不可以做什么、注意什么
```

**原则：**
- 不假设subagent知道任何context → 提供完整信息
- 明确输出位置和格式 → 避免结果丢失
- 设置timeout → 防止失控
- 一个subagent一个明确目标 → 不给模糊大任务

### 结果汇报格式
向Alex报告subagent结果时，**标注使用的模型**：
```
✅ [任务名] 完成（模型：Kimi K2.5）
[结果摘要]
```

### 关键任务的结果验证
关键任务的subagent结果，在采纳前做轻量校验（控制校验成本）。

---

## 3. 模型分配规则

| 任务类型 | 模型 | 说明 |
|---------|------|------|
| 复杂推理/架构设计 | **Opus 4.6** | 最强思维能力 |
| 内容创作（大量规则约束） | **Opus 4.6** | 规则多时不降级 |
| **修改OpenClaw配置/系统文件** | **Opus 4.6（强制）** | K2.5曾多次改崩系统 |
| 内容创作（轻量/创意） | Sonnet 4 / K2.5 | 视情况选择 |
| 信息提炼/总结/搜索 | **K2.5** | 成本优先 |
| 代码/技术任务 | **K2.5** | 编码能力强+便宜 |
| 批量/重复性任务 | **K2.5** | 成本优先 |

**核心原则：用能完成任务的最便宜模型，不过度配置。**

---

## 4. 并发控制

| 维度 | 规则 |
|------|------|
| 最大并发subagent | **4个** |
| 同一API/provider | **不同时发多个请求**（分散到不同provider） |
| 单个subagent默认timeout | **5分钟** |
| 复杂任务timeout | **10分钟**（视情况调整） |

**注意：** Alex会提供多个API key用于分散并发。

---

## 5. 成本控制

### 预警阈值
| 级别 | 阈值 | 动作 |
|------|------|------|
| ⚠️ 预警 | **$30/天** | 通知Alex，评估是否继续 |
| 🚨 硬限 | **$50/天** | 暂停非紧急任务，等Alex确认 |

### 成本监控方式
- 从session jsonl中读取usage.cost.total字段
- 可在heartbeat或日志群发成本日报

---

## 6. 失败处理

### 自主处理（不需问Alex）
| 失败类型 | 处理方式 |
|---------|---------|
| Rate limit | 等30秒重试，或换provider |
| Timeout | 分析原因，拆分任务或换模型 |
| 工具调用失败 | 自行排查修复 |
| 质量不达标 | 换更强模型重做 |

### 需要问Alex的情况
- 自己无法按原计划/方法解决
- 需要重构方法（可能大幅增加token费用）
- 连续失败无头绪

---

## 7. 经验积累

每次复杂任务完成后，在本文件底部记录：
- 什么方案有效
- 什么踩了坑
- 下次怎么优化

---

## 执行经验日志

| 日期 | 任务 | 经验教训 |
|------|------|---------|
| 2026-02-13 | 口红搜索（4并发subagent） | 4个并发OK但接近rate_limit边界 |
| 2026-02-14 | 数字孪生体系搭建 | 直接做比spawn更快（结构化写入任务） |
